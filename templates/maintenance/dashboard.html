{% extends 'base.html' %}
{% load static %}

{% block title %}Maintenance Dashboard - {{ staff.name|default:"Maintenance Staff" }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-orange-500 to-orange-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <i class="fas fa-tools text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Maintenance Dashboard</h1>
                        <p class="text-sm text-orange-100">{{ staff.name|default:"Maintenance Staff" }} - Work Orders</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Refresh Button -->
                    <button onclick="location.reload()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                    
                    <!-- User Profile Menu -->
                    <div class="relative">
                        <button id="userMenuButton" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                            <i class="fas fa-user-circle"></i>
                            <span>{{ staff.name|default:"Profile" }}</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border py-1 z-50">
                            <a href="{% url 'maintenance_profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-user-circle mr-2"></i>My Profile
                            </a>
                            <a href="{% url 'change_password' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-key mr-2"></i>Change Password
                            </a>
                            <hr class="my-1">
                            <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-yellow-500">
                <div class="flex items-center">
                    <div class="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Pending</p>
                        <p class="text-3xl font-bold text-gray-900">{{ pending_requests|default:0 }}</p>
                        <p class="text-xs text-gray-500">Awaiting action</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
                <div class="flex items-center">
                    <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-spinner text-blue-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">In Progress</p>
                        <p class="text-3xl font-bold text-gray-900">{{ in_progress_requests|default:0 }}</p>
                        <p class="text-xs text-gray-500">Being worked on</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
                <div class="flex items-center">
                    <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Completed Today</p>
                        <p class="text-3xl font-bold text-gray-900">{{ completed_today|default:0 }}</p>
                        <p class="text-xs text-gray-500">Finished</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
                <div class="flex items-center">
                    <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">High Priority</p>
                        <p class="text-3xl font-bold text-gray-900">{{ high_priority_requests.count|default:0 }}</p>
                        <p class="text-xs text-gray-500">Urgent issues</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- High Priority Requests -->
            {% if high_priority_requests %}
            <div class="lg:col-span-3 bg-white rounded-xl shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200 bg-red-50 rounded-t-xl">
                    <h2 class="text-lg font-semibold text-red-800">
                        <i class="fas fa-exclamation-circle mr-2"></i>High Priority & Emergency Requests
                    </h2>
                    <p class="text-sm text-red-600">These issues require immediate attention</p>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for request in high_priority_requests %}
                        <div class="border-2 {% if request.priority == 'emergency' %}border-red-400 bg-red-50{% else %}border-orange-400 bg-orange-50{% endif %} rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full {% if request.priority == 'emergency' %}bg-red-600 text-white{% else %}bg-orange-600 text-white{% endif %}">
                                    {{ request.priority|upper }}
                                </span>
                                <span class="text-xs text-gray-500">{{ request.created_at|timesince }} ago</span>
                            </div>
                            <h3 class="font-semibold text-gray-900">{{ request.issue_type|title }}</h3>
                            <p class="text-sm text-gray-600 mb-2">Room {{ request.room_number }}</p>
                            <p class="text-sm text-gray-700 line-clamp-2">{{ request.description|truncatewords:15 }}</p>
                            <div class="mt-3 flex space-x-2">
                                <button onclick="updateStatus('{{ request.request_id }}', 'in_progress')" class="flex-1 bg-blue-600 text-white text-sm py-2 px-3 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-play mr-1"></i>Start
                                </button>
                                <button onclick="viewDetails('{{ request.request_id }}')" class="bg-gray-200 text-gray-700 text-sm py-2 px-3 rounded-lg hover:bg-gray-300 transition-colors">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- My Assigned Tasks -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-tasks mr-2"></i>My Assigned Tasks
                    </h2>
                </div>
                
                <div class="p-6">
                    {% if assigned_requests %}
                    <div class="space-y-4">
                        {% for request in assigned_requests %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full 
                                            {% if request.issue_type == 'electrical' %}bg-yellow-100 text-yellow-800
                                            {% elif request.issue_type == 'plumbing' %}bg-blue-100 text-blue-800
                                            {% elif request.issue_type == 'hvac' %}bg-cyan-100 text-cyan-800
                                            {% elif request.issue_type == 'furniture' %}bg-amber-100 text-amber-800
                                            {% elif request.issue_type == 'cleaning' %}bg-green-100 text-green-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ request.issue_type|title }}
                                        </span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full 
                                            {% if request.priority == 'emergency' %}bg-red-100 text-red-800
                                            {% elif request.priority == 'high' %}bg-orange-100 text-orange-800
                                            {% elif request.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-green-100 text-green-800{% endif %}">
                                            {{ request.priority|title }}
                                        </span>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                            {{ request.status|title }}
                                        </span>
                                    </div>
                                    <h3 class="font-medium text-gray-900">Room {{ request.room_number }} - Block {{ request.student.block }}</h3>
                                    <p class="text-sm text-gray-600 mt-1">{{ request.description|truncatewords:20 }}</p>
                                    <p class="text-xs text-gray-500 mt-2">
                                        <i class="fas fa-user mr-1"></i>{{ request.student.name }} â€¢ 
                                        <i class="fas fa-clock mr-1"></i>{{ request.created_at|timesince }} ago
                                    </p>
                                </div>
                                <div class="flex flex-col space-y-2 ml-4">
                                    {% if request.status == 'assigned' %}
                                    <button onclick="updateStatus('{{ request.request_id }}', 'in_progress')" class="bg-blue-600 text-white text-sm py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-play mr-1"></i>Start
                                    </button>
                                    {% elif request.status == 'in_progress' %}
                                    <button onclick="updateStatus('{{ request.request_id }}', 'completed')" class="bg-green-600 text-white text-sm py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-check mr-1"></i>Complete
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-clipboard-check text-4xl mb-3"></i>
                        <p>No tasks assigned to you</p>
                        <p class="text-sm">Check pending requests below</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Issue Type Legend -->
            <div class="bg-white rounded-xl shadow-sm">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-info-circle mr-2"></i>Issue Types
                    </h2>
                </div>
                
                <div class="p-6 space-y-3">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-bolt text-yellow-600"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Electrical</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-faucet text-blue-600"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Plumbing</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-fan text-cyan-600"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">HVAC / AC</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chair text-amber-600"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Furniture</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-broom text-green-600"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Cleaning</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-question text-gray-600"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Other</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All Pending Requests -->
        <div class="mt-8 bg-white rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-list mr-2"></i>All Pending Requests
                </h2>
            </div>
            
            <div class="p-6">
                {% if all_pending_requests %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reported</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for request in all_pending_requests %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ request.room_number }}</div>
                                    <div class="text-xs text-gray-500">{{ request.student.name }}</div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full 
                                        {% if request.issue_type == 'electrical' %}bg-yellow-100 text-yellow-800
                                        {% elif request.issue_type == 'plumbing' %}bg-blue-100 text-blue-800
                                        {% elif request.issue_type == 'hvac' %}bg-cyan-100 text-cyan-800
                                        {% elif request.issue_type == 'furniture' %}bg-amber-100 text-amber-800
                                        {% elif request.issue_type == 'cleaning' %}bg-green-100 text-green-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ request.issue_type|title }}
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full 
                                        {% if request.priority == 'emergency' %}bg-red-100 text-red-800
                                        {% elif request.priority == 'high' %}bg-orange-100 text-orange-800
                                        {% elif request.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                        {% else %}bg-green-100 text-green-800{% endif %}">
                                        {{ request.priority|title }}
                                    </span>
                                </td>
                                <td class="px-4 py-4">
                                    <div class="text-sm text-gray-700 max-w-xs truncate">{{ request.description|truncatewords:10 }}</div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ request.created_at|timesince }} ago
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <button onclick="acceptTask('{{ request.request_id }}')" class="bg-blue-600 text-white text-sm py-1 px-3 rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-hand-paper mr-1"></i>Accept
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-check-circle text-4xl mb-3 text-green-500"></i>
                    <p class="font-medium">All caught up!</p>
                    <p class="text-sm">No pending maintenance requests</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md mx-4 w-full">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Update Task Status</h3>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Add Notes (Optional)</label>
            <textarea id="statusNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500" placeholder="Enter any notes about this task..."></textarea>
        </div>
        <div class="flex space-x-3">
            <button onclick="closeStatusModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                Cancel
            </button>
            <button id="confirmStatusBtn" class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                Update Status
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // User menu toggle
    document.getElementById('userMenuButton').addEventListener('click', function() {
        document.getElementById('userMenu').classList.toggle('hidden');
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('userMenu');
        const button = document.getElementById('userMenuButton');
        if (!button.contains(event.target) && !menu.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });
    
    let currentRequestId = null;
    let currentNewStatus = null;
    
    function updateStatus(requestId, newStatus) {
        currentRequestId = requestId;
        currentNewStatus = newStatus;
        document.getElementById('statusModal').classList.remove('hidden');
        
        document.getElementById('confirmStatusBtn').onclick = function() {
            const notes = document.getElementById('statusNotes').value;
            
            // TODO: Implement API call to update status
            console.log('Updating', requestId, 'to', newStatus, 'with notes:', notes);
            
            alert(`Task status updated to: ${newStatus}`);
            closeStatusModal();
            location.reload();
        };
    }
    
    function closeStatusModal() {
        document.getElementById('statusModal').classList.add('hidden');
        document.getElementById('statusNotes').value = '';
    }
    
    function acceptTask(requestId) {
        if (confirm('Accept this maintenance task?')) {
            // TODO: Implement API call to assign task to self
            console.log('Accepting task:', requestId);
            alert('Task accepted! It will appear in your assigned tasks.');
            location.reload();
        }
    }
    
    function viewDetails(requestId) {
        // TODO: Implement view details modal
        alert('View details for request: ' + requestId);
    }
</script>
{% endblock %}
