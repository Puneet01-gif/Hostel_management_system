<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Security Verification Dashboard - Hostel Coordination System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Title -->
                <div class="flex items-center">
                    <div class="bg-red-100 w-8 h-8 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-shield-alt text-red-600"></i>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-800">Security Verification</h1>
                </div>

                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm font-medium text-gray-800">Security Personnel</div>
                        <div class="text-xs text-gray-600">Pass Verification System</div>
                    </div>
                    <div class="bg-red-100 w-10 h-10 rounded-full flex items-center justify-center text-red-600">
                        <i class="fas fa-user-shield"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-2xl text-white p-8 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Digital Pass Verification</h2>
                    <p class="text-red-100">Verify student leave passes and permissions</p>
                </div>
                <div class="hidden md:block">
                    <div class="bg-white bg-opacity-20 rounded-full w-20 h-20 flex items-center justify-center">
                        <i class="fas fa-qrcode text-4xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Verification Panel -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Pass Verification Form -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-6">Verify Digital Pass</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pass Number</label>
                            <div class="flex space-x-3">
                                <input type="text" id="passNumber" placeholder="Enter pass number (e.g., LP-20260129-1234)" 
                                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-lg font-mono">
                                <button onclick="verifyPass()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                                    <i class="fas fa-search mr-2"></i>Verify
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Verified By (Optional)</label>
                            <input type="text" id="verifiedBy" placeholder="Enter your name or ID" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        
                        <div class="text-center text-gray-500">
                            <p class="text-sm">OR</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Student Name</label>
                            <div class="flex space-x-3">
                                <input type="text" id="studentName" placeholder="Enter student name" 
                                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <button onclick="searchByName()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                                    <i class="fas fa-user-search mr-2"></i>Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Verification Results -->
                <div id="verificationResults" class="hidden bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-6">Verification Results</h3>
                    <div id="verificationContent">
                        <!-- Results will be populated here -->
                    </div>
                </div>

                <!-- Search Results -->
                <div id="searchResults" class="hidden bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-6">Student Search Results</h3>
                    <div id="searchContent">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Quick Stats -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Today's Summary</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="text-sm text-gray-700">Active Passes</span>
                            </div>
                            <span id="activePassesCount" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                                Loading...
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-user-clock text-blue-500 mr-2"></i>
                                <span class="text-sm text-gray-700">Students Away</span>
                            </div>
                            <span id="studentsAwayCount" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                                Loading...
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-times-circle text-red-500 mr-2"></i>
                                <span class="text-sm text-gray-700">Expired Passes</span>
                            </div>
                            <span id="expiredPassesCount" class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">
                                Loading...
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Recent Verifications -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Verifications</h3>
                    <div id="recentVerifications">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-history text-2xl mb-2"></i>
                            <p class="text-sm">No recent verifications</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-6 border border-red-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Quick Actions</h3>
                    <div class="space-y-2">
                        <button onclick="refreshStats()" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Stats
                        </button>
                        <button onclick="viewAllActivePasses()" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-700 transition-colors">
                            <i class="fas fa-list mr-2"></i>View All Active Passes
                        </button>
                        <button onclick="showBulkVerification()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                            <i class="fas fa-check-double mr-2"></i>Bulk Verify
                        </button>
                        <button onclick="showDateRangeFilter()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition-colors">
                            <i class="fas fa-calendar-alt mr-2"></i>Date Range Filter
                        </button>
                        <button onclick="exportSecurityReport()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Active Passes Modal -->
    <div id="activePassesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[80vh] overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">All Active Passes</h3>
                <button onclick="closeActivePassesModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]" id="activePassesContent">
                <!-- Content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Bulk Verification Modal -->
    <div id="bulkVerificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Bulk Pass Verification</h3>
                <button onclick="closeBulkVerificationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pass Numbers (one per line)</label>
                        <textarea id="bulkPassNumbers" rows="6" placeholder="LP-20260129-1234&#10;LP-20260129-5678&#10;LP-20260129-9012" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 font-mono text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Verified By</label>
                        <input type="text" id="bulkVerifiedBy" placeholder="Enter your name or ID" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="processBulkVerification()" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-check-double mr-2"></i>Verify All Passes
                        </button>
                        <button onclick="closeBulkVerificationModal()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
                <div id="bulkVerificationResults" class="hidden mt-6">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Filter Modal -->
    <div id="dateRangeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl">
            <div class="flex items-center justify-between p-6 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Filter Students by Date Range</h3>
                <button onclick="closeDateRangeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="startDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                            <input type="date" id="endDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="filterByDateRange()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-filter mr-2"></i>Filter Students
                        </button>
                        <button onclick="closeDateRangeModal()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
                <div id="dateRangeResults" class="hidden mt-6">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadRecentVerifications();
        });

        function verifyPass() {
            const passNumber = document.getElementById('passNumber').value.trim();
            const verifiedBy = document.getElementById('verifiedBy').value.trim() || 'Security Personnel';
            
            if (!passNumber) {
                alert('Please enter a pass number');
                return;
            }

            // Show loading state
            document.getElementById('verificationResults').classList.remove('hidden');
            document.getElementById('verificationContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Verifying pass...</p>
                </div>
            `;

            // Hide search results
            document.getElementById('searchResults').classList.add('hidden');

            fetch('/api/verify-pass/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    pass_number: passNumber,
                    verified_by: verifiedBy
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayVerificationResult(data.verification_result);
                    // Refresh recent verifications after successful verification
                    if (data.verification_result.valid) {
                        setTimeout(loadRecentVerifications, 1000);
                    }
                } else {
                    document.getElementById('verificationContent').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg font-semibold">Verification Failed</p>
                            <p>${data.error}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('verificationContent').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p class="text-lg font-semibold">Error</p>
                        <p>An error occurred while verifying the pass</p>
                    </div>
                `;
            });
        }

        function displayVerificationResult(result) {
            const isValid = result.valid;
            const statusColor = isValid ? 'green' : 'red';
            const statusIcon = isValid ? 'check-circle' : 'times-circle';
            const statusText = isValid ? 'VALID PASS' : 'INVALID PASS';

            let content = `
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-${statusColor}-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-${statusIcon} text-${statusColor}-600 text-3xl"></i>
                    </div>
                    <h4 class="text-2xl font-bold text-${statusColor}-600">${statusText}</h4>
                </div>
            `;

            if (isValid) {
                content += `
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h5 class="font-semibold text-gray-800 mb-3">Student Information</h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Name:</span>
                                        <span class="font-medium">${result.student_name}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Student ID:</span>
                                        <span class="font-medium">${result.student_id}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Room:</span>
                                        <span class="font-medium">${result.room_number}, Block ${result.block}</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800 mb-3">Leave Details</h5>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">From Date:</span>
                                        <span class="font-medium">${formatDate(result.from_date)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">To Date:</span>
                                        <span class="font-medium">${formatDate(result.to_date)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Days:</span>
                                        <span class="font-medium">${result.total_days}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Days Remaining:</span>
                                        <span class="font-medium">${result.days_remaining}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <h5 class="font-semibold text-gray-800 mb-2">Reason for Leave</h5>
                            <p class="text-sm text-gray-700">${result.reason}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Verification Code:</span>
                                <span class="font-mono font-bold text-lg">${result.verification_code}</span>
                            </div>
                            ${result.last_verified ? `
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-sm text-gray-600">Last Verified:</span>
                                    <span class="text-sm font-medium">${formatDateTime(result.last_verified)}</span>
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-sm text-gray-600">Verified By:</span>
                                    <span class="text-sm font-medium">${result.verified_by}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                content += `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <p class="text-red-700 text-center">
                            ${result.error || 'This pass is not valid or has expired.'}
                        </p>
                    </div>
                `;
            }

            document.getElementById('verificationContent').innerHTML = content;
        }

        function searchByName() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                alert('Please enter a student name');
                return;
            }

            // Show loading state
            document.getElementById('searchResults').classList.remove('hidden');
            document.getElementById('searchContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Searching for student...</p>
                </div>
            `;

            // Hide verification results
            document.getElementById('verificationResults').classList.add('hidden');

            fetch('/api/security/search-students/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    student_name: studentName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySearchResults(data.students);
                } else {
                    document.getElementById('searchContent').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg font-semibold">Search Failed</p>
                            <p>${data.error}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('searchContent').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p class="text-lg font-semibold">Error</p>
                        <p>An error occurred while searching</p>
                    </div>
                `;
            });
        }

        function displaySearchResults(students) {
            if (students.length === 0) {
                document.getElementById('searchContent').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-user-slash text-4xl mb-4"></i>
                        <p class="text-lg font-semibold">No Students Found</p>
                        <p>No students found with that name.</p>
                    </div>
                `;
                return;
            }

            const studentsHtml = students.map(student => {
                const passesHtml = student.active_passes.length > 0 
                    ? student.active_passes.map(pass => `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-mono font-bold text-sm">${pass.pass_number}</span>
                                <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">
                                    ${pass.is_valid ? 'Valid' : 'Expired'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-700">
                                <div>From: ${formatDate(pass.from_date)} to ${formatDate(pass.to_date)}</div>
                                <div>Reason: ${pass.reason}</div>
                                <div>Verification: ${pass.verification_code}</div>
                            </div>
                        </div>
                    `).join('')
                    : '<p class="text-sm text-gray-500 italic">No active passes</p>';

                return `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="font-medium text-gray-800">${student.name}</div>
                                <div class="text-sm text-gray-600">${student.student_id} • Room ${student.room_number}, Block ${student.block}</div>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                    ${student.active_passes.length} pass${student.active_passes.length !== 1 ? 'es' : ''}
                                </span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h5 class="font-medium text-gray-800 mb-2">Active Passes:</h5>
                            ${passesHtml}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('searchContent').innerHTML = studentsHtml;
        }

        function loadStats() {
            fetch('/api/security/stats/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('activePassesCount').textContent = data.stats.active_passes;
                        document.getElementById('studentsAwayCount').textContent = data.stats.students_away;
                        document.getElementById('expiredPassesCount').textContent = data.stats.expired_passes;
                    } else {
                        console.error('Failed to load stats:', data.error);
                        document.getElementById('activePassesCount').textContent = 'Error';
                        document.getElementById('studentsAwayCount').textContent = 'Error';
                        document.getElementById('expiredPassesCount').textContent = 'Error';
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    document.getElementById('activePassesCount').textContent = 'Error';
                    document.getElementById('studentsAwayCount').textContent = 'Error';
                    document.getElementById('expiredPassesCount').textContent = 'Error';
                });
        }

        function loadRecentVerifications() {
            fetch('/api/security/recent-verifications/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayRecentVerifications(data.recent_verifications);
                    } else {
                        console.error('Failed to load recent verifications:', data.error);
                        document.getElementById('recentVerifications').innerHTML = `
                            <div class="text-center py-4 text-red-500">
                                <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                                <p class="text-sm">Failed to load verifications</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading recent verifications:', error);
                    document.getElementById('recentVerifications').innerHTML = `
                        <div class="text-center py-4 text-red-500">
                            <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                            <p class="text-sm">Error loading verifications</p>
                        </div>
                    `;
                });
        }

        function displayRecentVerifications(verifications) {
            const container = document.getElementById('recentVerifications');
            
            if (verifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-history text-2xl mb-2"></i>
                        <p class="text-sm">No recent verifications</p>
                    </div>
                `;
                return;
            }

            const verificationsHtml = verifications.map(verification => {
                const timeAgo = getTimeAgo(verification.verification_time);
                return `
                    <div class="border-b border-gray-200 pb-3 mb-3 last:border-b-0 last:pb-0 last:mb-0">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-sm text-gray-800">${verification.student_name}</span>
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            <div>Pass: ${verification.pass_number}</div>
                            <div>By: ${verification.verified_by}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = verificationsHtml;
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const now = new Date();
            const time = new Date(timestamp);
            const diffInMinutes = Math.floor((now - time) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours}h ago`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays}d ago`;
        }

        function refreshStats() {
            document.getElementById('activePassesCount').textContent = 'Loading...';
            document.getElementById('studentsAwayCount').textContent = 'Loading...';
            document.getElementById('expiredPassesCount').textContent = 'Loading...';
            
            setTimeout(() => {
                loadStats();
                loadRecentVerifications();
            }, 1000);
        }

        function viewAllActivePasses() {
            document.getElementById('activePassesModal').classList.remove('hidden');
            document.getElementById('activePassesContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Loading active passes...</p>
                </div>
            `;

            fetch('/api/security/active-passes/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayAllActivePasses(data.active_passes);
                    } else {
                        document.getElementById('activePassesContent').innerHTML = `
                            <div class="text-center py-8 text-red-500">
                                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                                <p class="text-lg font-semibold">Error</p>
                                <p>${data.error}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading active passes:', error);
                    document.getElementById('activePassesContent').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg font-semibold">Error</p>
                            <p>Failed to load active passes</p>
                        </div>
                    `;
                });
        }

        function displayAllActivePasses(passes) {
            if (passes.length === 0) {
                document.getElementById('activePassesContent').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-info-circle text-4xl mb-4"></i>
                        <p class="text-lg font-semibold">No Active Passes</p>
                        <p>There are currently no active digital passes.</p>
                    </div>
                `;
                return;
            }

            const passesHtml = passes.map(pass => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="bg-green-100 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-id-card text-green-600"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${pass.student_name}</div>
                                <div class="text-sm text-gray-600">${pass.student_id} • Room ${pass.room_number}, Block ${pass.block}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono font-bold text-sm">${pass.pass_number}</div>
                            <div class="text-xs text-gray-600">Code: ${pass.verification_code}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 text-sm mb-3">
                        <div>
                            <span class="text-gray-600">From:</span>
                            <div class="font-medium">${formatDate(pass.from_date)}</div>
                        </div>
                        <div>
                            <span class="text-gray-600">To:</span>
                            <div class="font-medium">${formatDate(pass.to_date)}</div>
                        </div>
                        <div>
                            <span class="text-gray-600">Days Left:</span>
                            <div class="font-medium">${pass.days_remaining}</div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <strong>Reason:</strong> ${pass.reason}
                    </div>
                </div>
            `).join('');

            document.getElementById('activePassesContent').innerHTML = passesHtml;
        }

        function closeActivePassesModal() {
            document.getElementById('activePassesModal').classList.add('hidden');
        }

        function showBulkVerification() {
            document.getElementById('bulkVerificationModal').classList.remove('hidden');
            document.getElementById('bulkVerificationResults').classList.add('hidden');
            document.getElementById('bulkPassNumbers').value = '';
            document.getElementById('bulkVerifiedBy').value = '';
        }

        function closeBulkVerificationModal() {
            document.getElementById('bulkVerificationModal').classList.add('hidden');
        }

        function processBulkVerification() {
            const passNumbersText = document.getElementById('bulkPassNumbers').value.trim();
            const verifiedBy = document.getElementById('bulkVerifiedBy').value.trim() || 'Security Personnel';
            
            if (!passNumbersText) {
                alert('Please enter at least one pass number');
                return;
            }

            const passNumbers = passNumbersText.split('\n').map(line => line.trim()).filter(line => line);
            
            if (passNumbers.length === 0) {
                alert('Please enter valid pass numbers');
                return;
            }

            // Show loading state
            document.getElementById('bulkVerificationResults').classList.remove('hidden');
            document.getElementById('bulkVerificationResults').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Verifying ${passNumbers.length} passes...</p>
                </div>
            `;

            fetch('/api/security/bulk-verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    pass_numbers: passNumbers,
                    verified_by: verifiedBy
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayBulkVerificationResults(data.results);
                    // Refresh recent verifications
                    setTimeout(loadRecentVerifications, 1000);
                } else {
                    document.getElementById('bulkVerificationResults').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg font-semibold">Bulk Verification Failed</p>
                            <p>${data.error}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('bulkVerificationResults').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p class="text-lg font-semibold">Error</p>
                        <p>An error occurred during bulk verification</p>
                    </div>
                `;
            });
        }

        function displayBulkVerificationResults(results) {
            const validCount = results.filter(r => r.verification_result.valid).length;
            const invalidCount = results.length - validCount;

            let content = `
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">Verification Summary</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-800">${results.length}</div>
                            <div class="text-gray-600">Total</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${validCount}</div>
                            <div class="text-gray-600">Valid</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${invalidCount}</div>
                            <div class="text-gray-600">Invalid</div>
                        </div>
                    </div>
                </div>
            `;

            content += '<div class="space-y-3 max-h-60 overflow-y-auto">';
            
            results.forEach(result => {
                const isValid = result.verification_result.valid;
                const statusColor = isValid ? 'green' : 'red';
                const statusIcon = isValid ? 'check-circle' : 'times-circle';

                content += `
                    <div class="border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-mono font-bold text-sm">${result.pass_number}</span>
                            <div class="flex items-center">
                                <i class="fas fa-${statusIcon} text-${statusColor}-500 mr-2"></i>
                                <span class="text-sm font-medium text-${statusColor}-600">
                                    ${isValid ? 'VALID' : 'INVALID'}
                                </span>
                            </div>
                        </div>
                        ${isValid ? `
                            <div class="text-sm text-gray-700">
                                <div><strong>${result.verification_result.student_name}</strong> (${result.verification_result.student_id})</div>
                                <div>Room ${result.verification_result.room_number}, Block ${result.verification_result.block}</div>
                                <div>Valid until: ${formatDate(result.verification_result.to_date)}</div>
                            </div>
                        ` : `
                            <div class="text-sm text-red-600">
                                ${result.verification_result.error || 'Pass is invalid or expired'}
                            </div>
                        `}
                    </div>
                `;
            });

            content += '</div>';
            document.getElementById('bulkVerificationResults').innerHTML = content;
        }

        function showDateRangeFilter() {
            document.getElementById('dateRangeModal').classList.remove('hidden');
            document.getElementById('dateRangeResults').classList.add('hidden');
            
            // Set default dates (today and 7 days from now)
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('startDate').value = today.toISOString().split('T')[0];
            document.getElementById('endDate').value = nextWeek.toISOString().split('T')[0];
        }

        function closeDateRangeModal() {
            document.getElementById('dateRangeModal').classList.add('hidden');
        }

        function filterByDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            // Show loading state
            document.getElementById('dateRangeResults').classList.remove('hidden');
            document.getElementById('dateRangeResults').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Filtering students...</p>
                </div>
            `;

            fetch(`/api/security/students-by-date/?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayDateRangeResults(data);
                    } else {
                        document.getElementById('dateRangeResults').innerHTML = `
                            <div class="text-center py-8 text-red-500">
                                <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                                <p class="text-lg font-semibold">Filter Failed</p>
                                <p>${data.error}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('dateRangeResults').innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p class="text-lg font-semibold">Error</p>
                            <p>An error occurred while filtering</p>
                        </div>
                    `;
                });
        }

        function displayDateRangeResults(data) {
            let content = `
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">Filter Results</h4>
                    <div class="text-sm text-gray-600">
                        <div>Date Range: ${formatDate(data.date_range.start_date)} to ${formatDate(data.date_range.end_date)}</div>
                        <div>Students Found: ${data.total_count}</div>
                    </div>
                </div>
            `;

            if (data.students_with_passes.length === 0) {
                content += `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-info-circle text-4xl mb-4"></i>
                        <p class="text-lg font-semibold">No Students Found</p>
                        <p>No students have passes valid within the selected date range.</p>
                    </div>
                `;
            } else {
                content += '<div class="space-y-3 max-h-60 overflow-y-auto">';
                
                data.students_with_passes.forEach(student => {
                    content += `
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <div class="font-medium text-gray-800">${student.student_name}</div>
                                    <div class="text-sm text-gray-600">${student.student_id} • Room ${student.room_number}, Block ${student.block}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-mono font-bold text-sm">${student.pass_number}</div>
                                    <div class="text-xs text-gray-600">Code: ${student.verification_code}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm text-gray-700">
                                <div>
                                    <span class="text-gray-600">From:</span>
                                    <div class="font-medium">${formatDate(student.from_date)}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">To:</span>
                                    <div class="font-medium">${formatDate(student.to_date)}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">Days:</span>
                                    <div class="font-medium">${student.total_days}</div>
                                </div>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                <strong>Reason:</strong> ${student.reason}
                            </div>
                        </div>
                    `;
                });

                content += '</div>';
            }

            document.getElementById('dateRangeResults').innerHTML = content;
        }

        function exportSecurityReport() {
            const startDate = prompt('Enter start date (YYYY-MM-DD) or leave empty for last 7 days:');
            const endDate = prompt('Enter end date (YYYY-MM-DD) or leave empty for today:');
            
            let url = '/api/security/export-report/';
            const params = new URLSearchParams();
            
            if (startDate && startDate.trim()) {
                params.append('start_date', startDate.trim());
            }
            if (endDate && endDate.trim()) {
                params.append('end_date', endDate.trim());
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            // Create a temporary link to download the file
            const link = document.createElement('a');
            link.href = url;
            link.download = 'security_report.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Utility function to get CSRF token
        function getCookie(name) {
            // First try to get from meta tag
            const token = document.querySelector('meta[name="csrf-token"]');
            if (token && name === 'csrftoken') {
                return token.getAttribute('content');
            }
            
            // Fallback to cookie
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Allow Enter key to trigger verification
        document.getElementById('passNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyPass();
            }
        });

        document.getElementById('studentName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchByName();
            }
        });
    </script>
</body>
</html>